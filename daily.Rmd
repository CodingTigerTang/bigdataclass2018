---
title: "Untitled"
output: html_document
---

```{r}
library(tidyverse)
library(lubridate)
library(sparklyr)

top_rows <- read.csv("/usr/share/flights/data/flight_2008_1.csv", nrows = 5)
file_columns <- top_rows %>%
  rename_all(tolower) %>%
  map(function(x) "character")

sc <- spark_connect(master = "local", version = "2.1.0")
spark_flights <- spark_read_csv(
  sc,
  name = "flights",
  path = "/usr/share/flights/flights_2008.csv",
  memory = FALSE,
  columns = file_columns,
  infer_schema = FALSE
)

reload <- ml_load(sc, "/tmp/saved_model")

current <- tbl(sc, "flights") %>%
  filter(
    month == !! month(now()),
    dayofmonth == !! day(now())
  )

new_predictions <- ml_transform(
  x = reload,
  dataset = current
)

new_predictions %>%
  summarise(late_fligths = sum(prediction, na.rm = TRUE))

spark_disconnect(sc)
```