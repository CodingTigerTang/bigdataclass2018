# External data

```{r, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

```{r, include = FALSE}

library(dplyr)
library(dbplyr)
library(DBI)
library(dbplot)

# Class catchup
con <- DBI::dbConnect(odbc::odbc(), "Postgres Dev")
airports <- tbl(con, in_schema("datawarehouse", "airport"))
flights <- tbl(con, in_schema("datawarehouse", "flight"))
carriers <- tbl(con, in_schema("datawarehouse", "carrier"))

```

##  Data enrichment
*Upload a small dataset in order to combine it with the datawarehouse data*

1. Load the `planes` data into memory
```{r}
planes <- nycflights13::planes
```

2. Using `DBI`, copy the `planes` data to the datawarehouse as a temporary table
```{r}
dbWriteTable(con, "planes", planes, temporary = TRUE)
```

3. Using `dplyr`, create a variable pointer to the new table
```{r}
tbl_planes <- tbl(con, "planes")
tbl_planes
```

4. Create a "lazy" variable that joins the flights table to the new temp table
```{r}
combined <- flights %>%
  left_join(tbl_planes, by = "tailnum") 

```

5. View a sample of flights of planes with more than 100 seats
```{r}
combined %>%
  filter(seats > 100) %>%
  head()
```

6. See how many flights each plane McDonnel Douglas had
```{r}
combined %>%
  filter(manufacturer == "MCDONNELL DOUGLAS") %>%
  group_by(tailnum) %>%
  tally() 
``` 

7. Get the total number of planes, and the average, minimum & maximum number of flights for the manufacturer
```{r}
combined %>%
  filter(manufacturer == "MCDONNELL DOUGLAS") %>%
  group_by(tailnum) %>%
  tally() %>%
  summarise(planes = n(),
            avg_flights = mean(n, na.rm = TRUE),
            max_flights = max(n, na.rm = TRUE),
            min_flights = min(n, na.rm = TRUE))
``` 


## Using other join statements
*Overview of the other joint statements*


```{r}
left <- flights %>%
  left_join(tbl_planes, by = "tailnum") 

tally(left)
```

```{r}
left %>%
  filter(is.na(manufacturer)) %>%
  tally()
```

```{r}
right <- flights %>%
  right_join(tbl_planes, by = "tailnum") 

tally(right)
```
```{r}
right %>%
  filter(is.na(manufacturer)) %>%
  tally()
```

```{r}
left %>%
  filter(!is.na(manufacturer)) %>%
  inner_join(right, by = "tailnum") %>%
  tally()
```

```{r}
dbRemoveTable(con, "planes")

dbDisconnect(con)

```








