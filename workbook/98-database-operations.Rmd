# Database operations

```{r, include = FALSE}

library(dplyr)
library(dbplyr)
library(DBI)
library(dbplot)

# Class catchup
con <- DBI::dbConnect(odbc::odbc(), "Postgres Dev")
airports <- tbl(con, in_schema("datawarehouse", "airport"))
flights <- tbl(con, in_schema("datawarehouse", "flight"))
carriers <- tbl(con, in_schema("datawarehouse", "carrier"))

```

## Case 1 - Data enrichment
*Upload a small dataset in order to combine it with the datawarehouse data*

1. Load the `planes` data into memory
```{r}
planes <- nycflights13::planes
```

2. Using `DBI`, copy the `planes` data to the datawarehouse as a temporary table
```{r}
dbWriteTable(con, "planes", planes, temporary = TRUE)
```

3. Using `dplyr`, create a variable pointer to the new table
```{r}
tbl_planes <- tbl(con, "planes")
tbl_planes
```

4. Create a "lazy" variable that joins the flights table to the new temp table
```{r}
combined <- flights %>%
  left_join(tbl_planes, by = "tailnum") 

```

5. View a sample of flights of planes with more than 100 seats
```{r}
combined %>%
  filter(seats > 100) %>%
  head()
```

6. See how many flights each plane McDonnel Douglas had
```{r}
combined %>%
  filter(manufacturer == "MCDONNELL DOUGLAS") %>%
  group_by(tailnum) %>%
  tally() 
``` 

7. Get the total number of planes, and the average, minimum & maximum number of flights for the manufacturer
```{r}
combined %>%
  filter(manufacturer == "MCDONNELL DOUGLAS") %>%
  group_by(tailnum) %>%
  tally() %>%
  summarise(planes = n(),
            avg_flights = mean(n),
            max_flights = max(n),
            min_flights = min(n))
``` 


8. Remove the temp table 
```{r}
dbRemoveTable(con, "planes")

dbDisconnect(con)
```








