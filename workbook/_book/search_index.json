[
["index.html", "Big Data with R - Exercise book", " Big Data with R - Exercise book Learn how to use R with Hive, SQL Server, Oracle and other scalable external data sources along with Big Data clusters in this two-day workshop. We will cover how to connect, retrieve schema information, upload data, and explore data outside of R. For databases, we will focus on the dplyr, DBI and odbc packages. These packages enable us to use the same dplyr verbs inside R but are translated and sent as SQL queries. For Big Data clusters, we will also learn how to use the sparklyr package to run models inside Spark and return the results to R. We will review recommendations for connection settings, security best practices and deployment options. Throughout the workshop, we will take advantage of the new data connections available with the RStudio IDE. "],
["access-a-database.html", "1 Access a database 1.1 Connect to a database 1.2 Explore the database using the RStudio IDE 1.3 List drivers and DSNs 1.4 Connect to a database using code 1.5 Connect to a database without a DSN 1.6 Secure credentials in a file 1.7 Use the OS credential store", " 1 Access a database 1.1 Connect to a database The simpliest way to connect to a database. More complex examples will be examined later in the class. Click on the Connections tab Click on the New Connection button Select Postgres Dev Click OK 1.2 Explore the database using the RStudio IDE Becoming familiar with the new interface for databases inside the RStudio IDE Expand the datawarehouse schema Expand the airport table Click on the table icon to the right of the airport table (Optional) Expand and explore the other tables Click on the disconnect icon to close the connection 1.3 List drivers and DSNs Learn how to use the odbc package to get DB info from your machine To get a list of drivers available in the server library(odbc) odbcListDrivers()[1:2] To see a list of DSNs available in the server odbcListDataSources() 1.4 Connect to a database using code Use the odbc package along with DBI to open a connection to a database Run the following code to connect library(DBI) con &lt;- dbConnect(odbc::odbc(), &quot;Postgres Dev&quot;) Use dbListTables() to retrieve a list of tables dbListTables(con) Use dbGetQuery() to run a quick query odbc::dbGetQuery(con, &quot;SELECT * FROM datawarehouse.airport LIMIT 10&quot;) Disconnect from the database using dbDisconnect() dbDisconnect(con) 1.5 Connect to a database without a DSN A more complex way of connecting to a database, using best practices: http://db.rstudio.com/best-practices/managing-credentials/#prompt-for-credentials Use the following code to start a new connection that does not use the pre-defined DSN con &lt;- dbConnect( odbc::odbc(), Driver = &quot;PostgreSQL&quot;, Server = &quot;localhost&quot;, UID = rstudioapi::askForPassword(&quot;Database user&quot;), PWD = rstudioapi::askForPassword(&quot;Database password&quot;), Port = 5432, Database = &quot;postgres&quot; ) When prompted, type in rstudio_dev for the user, and dev_user as the password 1.6 Secure credentials in a file *Credentials can be saved in a YAML file and then read using the config package: http://db.rstudio.com/best-practices/managing-credentials/#stored-in-a-file-with-config* Open and explore the config.yml file available in your working directory Use the config package to connect to the database dw &lt;- config::get(&quot;datawarehouse-dev&quot;) con &lt;- DBI::dbConnect(odbc::odbc(), Driver = dw$driver, Server = dw$server, UID = dw$uid, PWD = dw$pwd, Port = dw$port, Database = dw$database ) 1.7 Use the OS credential store The keyring package can be used to store the database credentials at the OS level [Pending] "],
["dplyr-basics.html", "2 dplyr Basics 2.1 Create a table variable 2.2 Basic aggregation 2.3 Under the hood 2.4 Un-translated R commands", " 2 dplyr Basics 2.1 Create a table variable Basics to how to point a variable in R to a table or view inside the database Load the dplyr and dbplyr libraries library(dplyr) library(dbplyr) (Optional) Open a connection to the database if it’s currently closed con &lt;- DBI::dbConnect(odbc::odbc(), &quot;Postgres Dev&quot;) Use the tbl() and in_schema() functions to create a reference to a table tbl(con, in_schema(&quot;datawarehouse&quot;, &quot;airport&quot;)) Load the reference, not the table data, into a variable airports &lt;- tbl(con, in_schema(&quot;datawarehouse&quot;, &quot;airport&quot;)) Call the variable to see preview the data in the table airports Set up the pointers to the other of the tables flights &lt;- tbl(con, in_schema(&quot;datawarehouse&quot;, &quot;flight&quot;)) carriers &lt;- tbl(con, in_schema(&quot;datawarehouse&quot;, &quot;carrier&quot;)) 2.2 Basic aggregation A couple of dplyr commands that run in-database How many records are in the airport table? tbl(con, in_schema(&quot;datawarehouse&quot;, &quot;vflight&quot;)) %&gt;% group_by(month) %&gt;% summarise(n()) What is the average character length of the airport codes? How many characters is the longest and the shortest airport name? airports %&gt;% summarise(avg_airport_length = mean(length(airport)), max_airport_name = max(length(airportname)), min_airport_name = min(length(airportname)), total_records = n()) Additional exercises: How many records are in the carrier table? How many characters is the longest carriername? 2.3 Under the hood Use show_query() to preview the SQL statement that will be sent to the database* SQL statement that actually runs when we ran airports as a command show_query(airports) Easily view the resulting query by adding show_query() in another piped command carriers %&gt;% summarise(n()) Run the same for last exercise in the previous section airports %&gt;% summarise(avg_airport_length = mean(length(airport)), max_airport_name = max(length(airportname)), min_airport_name = min(length(airportname)), total_records = n()) %&gt;% show_query() 2.4 Un-translated R commands Review of how dbplyr handles R commands that have not been translated into a like-SQL command Preview how Sys.time() is translated airports %&gt;% mutate(today = Sys.time()) %&gt;% show_query() Use PostgreSQL’s native commands, in this case now() airports %&gt;% mutate(today = now()) %&gt;% show_query() Run the dplyr code to confirm it works airports %&gt;% mutate(today = now()) %&gt;% select(today) %&gt;% head() "],
["data-transformation.html", "3 Data transformation 3.1 Group and sort records 3.2 Answering questions with dplyr 3.3 Aggregate mulitple columns 3.4 View record level data", " 3 Data transformation 3.1 Group and sort records Learn how to use group_by() and arrange() to better understand aggregated data How many flights are there per month? flights %&gt;% group_by(month) %&gt;% tally() Order the results by the month number flights %&gt;% group_by(month) %&gt;% tally() %&gt;% arrange(month) Order the results by the number of flights, starting with the month with most flights by using desc() inside the arrange() command flights %&gt;% group_by(month) %&gt;% tally() %&gt;% arrange(desc(n)) 3.2 Answering questions with dplyr Quick review of how to translate questions into dplyr code Which are the top 4 months with the most flight activity? flights %&gt;% group_by(month) %&gt;% tally() %&gt;% arrange(desc(n)) %&gt;% head(4) What were the top 5 calendar days with most flight activity? flights %&gt;% group_by(month, dayofmonth) %&gt;% tally() %&gt;% arrange(desc(n)) %&gt;% head(5) Which are the top 5 carriers (airlines) with the most flights? flights %&gt;% group_by(uniquecarrier) %&gt;% tally() %&gt;% arrange(desc(n)) %&gt;% head(5) Figure the percent ratio of flights per month flights %&gt;% group_by(month) %&gt;% tally() %&gt;% arrange(desc(n)) %&gt;% mutate(percent = n/sum(n)) 3.3 Aggregate mulitple columns Practice using summarise _ functions Use summarise_all() to send the same function to all fields flights %&gt;% select(depdelay, arrdelay) %&gt;% summarise_all(mean) Use summarise_at() to pre-select the fields that will receive the function flights %&gt;% summarise_at(c(&quot;depdelay&quot;, &quot;arrdelay&quot;),mean) Use summarise_if() to summarize only if the field meets a criterion flights %&gt;% summarise_if(is.numeric,mean) Combine with group_by() to create more complex results flights %&gt;% select(month, depdelay, arrdelay) %&gt;% group_by(month) %&gt;% summarise_all(mean) 3.4 View record level data Important tips to record preview data How many flights in July 18th were one or more hours late? flights %&gt;% filter(depdelay &gt;= 60, month == 7, dayofmonth == 18) %&gt;% tally() Use filter() to retreive only the needed data, and head() to limit the preview even further. flights %&gt;% filter(depdelay &gt;= 60, month == 7, dayofmonth == 18) %&gt;% head(100) Use collect() and View() to preview the data in the IDE. Make sure to always limit the number of returned rows. flights %&gt;% filter(depdelay &gt;= 60, month == 7, dayofmonth == 18) %&gt;% collect() %&gt;% head(100) %&gt;% View(&quot;my_preview&quot;) "],
["intro-to-dashboards.html", "4 Intro to dashboards 4.1 Basic structure 4.2 Dropdown data 4.3 Update dashboard items 4.4 Integrate the dropdown", " 4 Intro to dashboards 4.1 Basic structure Preview a simple shinydashboard Create and preview a simple shinydashboard ui &lt;- dashboardPage( dashboardHeader(title = &quot;Quick Example&quot;), dashboardSidebar(selectInput(&quot;select&quot;, &quot;Selection&quot;, c(&quot;one&quot;, &quot;two&quot;))), dashboardBody( valueBoxOutput(&quot;total&quot;), dataTableOutput(&quot;monthly&quot;) ) ) server &lt;- function(input, output, session) { output$total &lt;- renderValueBox(valueBox(100, subtitle = &quot;Flights&quot;)) output$monthly &lt;- renderDataTable(datatable(mtcars)) } shinyApp(ui, server) 4.2 Dropdown data Review a technique to populate a dropdown Use purrr to create a list with the correct structure for the shiny dropdown airline_list &lt;- carriers %&gt;% select(carrier, carriername) %&gt;% # In case more fields are added collect() %&gt;% # All would be collected anyway split(.$carriername) %&gt;% # Create a list item for each name map(~.$carrier) # Add the carrier code to each item head(airline_list) In the app code, replace c(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;) with airline_list # Goes from this: dashboardSidebar(selectInput(&quot;select&quot;, &quot;Selection&quot;, c(&quot;one&quot;, &quot;two&quot;))), # To this: dashboardSidebar(selectInput(&quot;select&quot;, &quot;Selection&quot;, airline_list)), Re-run the app 4.3 Update dashboard items Create base query for the dashboard using dplyr and pass the results to the dashboard Save the base “query” to a variable. It will contain a carrier selection. To transition into shiny programming easier, the variable will be a function. base_dashboard &lt;- function(){ flights %&gt;% filter(uniquecarrier == &quot;DL&quot;) } head(base_dashboard()) Use the base query to figure the number of flights for that carrier base_dashboard() %&gt;% tally() %&gt;% pull() In the app, remove the 100 number and pipe the dplyr code into the valueBox() function # Goes from this: output$total &lt;- renderValueBox(valueBox(100, subtitle = &quot;Flights&quot;)) # To this: output$total &lt;- renderValueBox( base_dashboard() %&gt;% tally() %&gt;% pull() %&gt;% valueBox(subtitle = &quot;Flights&quot;)) Create a table with the month name and the number of flights for that month base_dashboard() %&gt;% group_by(month) %&gt;% tally() %&gt;% collect() %&gt;% mutate(n = as.numeric(n)) %&gt;% rename(flights = n) %&gt;% arrange(month) In the app, replace head(mtcars) with the piped code, and re-run the app # Goes from this: output$monthly &lt;- renderTable(head(mtcars)) # To this: output$monthly &lt;- renderDataTable(datatable( base_dashboard() %&gt;% group_by(month) %&gt;% tally() %&gt;% collect() %&gt;% mutate(n = as.numeric(n)) %&gt;% rename(flights = n) %&gt;% arrange(month))) 4.4 Integrate the dropdown Use shiny’s reactive() function to integrate the user input in one spot In the original base_dashboard() code, replace function with reactive, and &quot;DL&quot; with input$select # Goes from this base_dashboard &lt;- function(){ flights %&gt;% filter(uniquecarrier == &quot;DL&quot;)} # To this base_dashboard &lt;- reactive({ flights %&gt;% filter(uniquecarrier == input$select)}) Insert the new code right after the server &lt;- function(input, output, session) line. The full code should now look like this: ui &lt;- dashboardPage( dashboardHeader(title = &quot;Quick Example&quot;), dashboardSidebar(selectInput(&quot;select&quot;, &quot;Selection&quot;, airline_list)), dashboardBody( valueBoxOutput(&quot;total&quot;), dataTableOutput(&quot;monthly&quot;) ) ) server &lt;- function(input, output, session) { base_dashboard &lt;- reactive({ flights %&gt;% filter(uniquecarrier == input$select)}) output$total &lt;- renderValueBox( base_dashboard() %&gt;% tally() %&gt;% pull() %&gt;% valueBox(subtitle = &quot;Flights&quot;)) output$monthly &lt;- renderDataTable(datatable( base_dashboard() %&gt;% group_by(month) %&gt;% tally() %&gt;% collect() %&gt;% mutate(n = as.numeric(n)) %&gt;% rename(flights = n) %&gt;% arrange(month) )) } shinyApp(ui, server) Re-run the app "],
["dashboard-drill-down.html", "5 Dashboard drill-down 5.1 Add a tabset to the dashboard 5.2 Add interactivity 5.3 Add title to the new tab", " 5 Dashboard drill-down 5.1 Add a tabset to the dashboard Prepare the ui to accept new tabs based on the user’s input Wrap the “output” functions in the ui with a tabPanel() # Goes from this valueBoxOutput(&quot;total&quot;), dataTableOutput(&quot;monthly&quot;) # To this tabPanel( valueBoxOutput(&quot;total&quot;), dataTableOutput(&quot;monthly&quot;) ) Set the panel’s title and value. The new code should look like this tabPanel( title = &quot;Dashboard&quot;, value = &quot;page1&quot;, valueBoxOutput(&quot;total&quot;), dataTableOutput(&quot;monthly&quot;) ) Wrap that code inside a tabsetPanel(), set the id to tabs tabsetPanel(id = &quot;tabs&quot;, tabPanel( title = &quot;Dashboard&quot;, value = &quot;page1&quot;, valueBoxOutput(&quot;total&quot;), dataTableOutput(&quot;monthly&quot;) ) ) Re-run the app 5.2 Add interactivity Add an click-event that creates a new tab Set the selection and rownames in the current datatable() function output$monthly &lt;- renderDataTable(datatable({ base_dashboard() %&gt;% group_by(month) %&gt;% tally() %&gt;% collect() %&gt;% mutate(n = as.numeric(n)) %&gt;% rename(flights = n) %&gt;% arrange(month)}, list( target = &quot;cell&quot;), # New code rownames = FALSE)) # New code Use observeEvent() and appendTab() to add the interactivity observeEvent(input$monthly_cell_clicked, { appendTab(inputId = &quot;tabs&quot;, # This is the tabsets panel&#39;s ID tabPanel(&quot;test_new&quot;, # This will be the label of the new tab renderDataTable(mtcars, rownames = FALSE)))}) Re-run the app Click on a row inside the datatable and then select the new tab called test_new to see the mtcars data 5.3 Add title to the new tab Use the input’s info to create a custom label Load the clicked cell’s info into a variable, and create a new lable by concatenating the cell’s month and the selected airline’s code observeEvent(input$monthly_cell_clicked, { cell &lt;- input$monthly_cell_clicked # New code if(!is.null(cell$value)){ # New code tab_title &lt;- paste0(month.name[cell$value], &quot;_&quot;, input$select) appendTab(inputId = &quot;tabs&quot;, tabPanel(tab_title, # Changed code renderDataTable(mtcars, rownames = FALSE))) }}) Re-run the app, and click on one of the month’s to confirm that the new label works Use updateTabsetPanel to switch the dashboard’s focus to the newly created tab. It goes after the tabPanel() code updateTabsetPanel(session, &quot;tabs&quot;, selected = tab_title) "],
["intro-to-sparklyr.html", "6 Intro to sparklyr 6.1 New Spark session 6.2 Data transfer 6.3 Advanced 6.4 Pipelines", " 6 Intro to sparklyr 6.1 New Spark session Learn to open a new Spark session Use spark_connect() to create a new local Spark session sc &lt;- spark_connect(master = &quot;local&quot;, version = &quot;2.1.0&quot;) Click on the SparkUI button to view the current Spark session’s UI Click on the Log button to see the message history 6.2 Data transfer Practice uploading data to Spark Copy the mtcars dataset into the session spark_mtcars &lt;- sdf_copy_to(sc, mtcars, &quot;my_mtcars&quot;) In the Connections pane, expande the my_mtcars table Go to the Spark UI, note the new jobs In the UI, click the Storage button, note the new table Click on the In-memory table my_mtcars link 6.2.1 Simple dplyr example See how Spark handles dplyr commands spark_mtcars %&gt;% group_by(am) %&gt;% summarise(avg_wt = mean(wt, na.rm = TRUE)) Go to the Spark UI and click the SQL button Click on the top item inside the Completed Queries table At the bottom of the diagram, expand Details 6.3 Advanced library(purrr) library(readr) top_rows &lt;- read.csv(&quot;/usr/share/flights/flights_2008.csv&quot;, nrows = 5) file_columns &lt;- top_rows %&gt;% rename_all(tolower) %&gt;% map(function(x)&quot;character&quot;) head(file_columns) spark_flights &lt;- spark_read_csv(sc, name = &quot;flights&quot;, path = &quot;/usr/share/flights/flights_2008.csv&quot;, memory = FALSE, columns = file_columns, infer_schema = FALSE) spark_flights %&gt;% tally() cached_flights &lt;- spark_flights %&gt;% select( month, dayofmonth, arrtime, arrdelay, depdelay, crsarrtime, crsdeptime, distance ) %&gt;% mutate_all(as.numeric) sdf_register(cached_flights, &quot;sub_flights&quot;) tbl_cache(sc, &quot;sub_flights&quot;) cached_flights %&gt;% tally() cached_flights %&gt;% arrange(month) %&gt;% sdf_pivot(month ~ dayofmonth) partition &lt;- cached_flights %&gt;% sdf_partition(training = 0.01, testing = 0.09, other = 0.9) tally(partition$training) cached_flights %&gt;% ft_binarizer( input.col = &quot;depdelay&quot;, output.col = &quot;delayed&quot;, threshold = 15 ) %&gt;% select( depdelay, delayed ) %&gt;% head(100) cached_flights %&gt;% ft_bucketizer( input.col = &quot;crsdeptime&quot;, output.col = &quot;dephour&quot;, splits = c(0, 400, 800, 1200, 1600, 2000, 2400) ) %&gt;% select( crsdeptime, dephour ) %&gt;% head(100) sample_data &lt;- cached_flights %&gt;% filter(!is.na(arrdelay)) %&gt;% ft_binarizer( input.col = &quot;arrdelay&quot;, output.col = &quot;delayed&quot;, threshold = 15 ) %&gt;% ft_bucketizer( input.col = &quot;crsdeptime&quot;, output.col = &quot;dephour&quot;, splits = c(0, 400, 800, 1200, 1600, 2000, 2400) ) %&gt;% mutate(dephour = paste0(&quot;h&quot;, as.integer(dephour))) %&gt;% sdf_partition(training = 0.01, testing = 0.09, other = 0.9) training &lt;- sdf_register(sample_data$training, &quot;training&quot;) tbl_cache(sc, &quot;training&quot;) delayed_model &lt;- training %&gt;% ml_logistic_regression(delayed ~ depdelay + dephour) summary(delayed_model) delayed_testing &lt;- sdf_predict(delayed_model, sample_data$testing) delayed_testing %&gt;% head() delayed_testing %&gt;% group_by(delayed, prediction) %&gt;% tally() 6.4 Pipelines current &lt;- tbl(sc, &quot;flights&quot;) %&gt;% sample_frac(0.001) %&gt;% sdf_register(., &quot;current&quot;) pipeline_df &lt;- current %&gt;% mutate( arrdelay = ifelse(arrdelay == &quot;NA&quot;, 0, arrdelay), depdelay = ifelse(depdelay == &quot;NA&quot;, 0, depdelay) ) %&gt;% select( month, dayofmonth, arrtime, arrdelay, depdelay, crsarrtime, crsdeptime, distance ) %&gt;% mutate_all(as.numeric) pipeline_df %&gt;% ft_binarizer( input.col = &quot;depdelay&quot;, output.col = &quot;delayed&quot;, threshold = 15 ) %&gt;% ft_bucketizer( input.col = &quot;crsdeptime&quot;, output.col = &quot;dephour&quot;, splits = c(0, 400, 800, 1200, 1600, 2000, 2400) ) %&gt;% ml_logistic_regression(delayed ~ arrdelay + dephour) flights_pipeline &lt;- ml_pipeline(sc) %&gt;% ft_dplyr_transformer( tbl = pipeline_df ) %&gt;% ft_binarizer( input.col = &quot;arrdelay&quot;, output.col = &quot;delayed&quot;, threshold = 15 ) %&gt;% ft_bucketizer( input.col = &quot;crsdeptime&quot;, output.col = &quot;dephour&quot;, splits = c(0, 400, 800, 1200, 1600, 2000, 2400) ) %&gt;% ft_r_formula(delayed ~ arrdelay + dephour) %&gt;% ml_logistic_regression() flights_pipeline model &lt;- ml_fit(flights_pipeline, current) model predictions &lt;- ml_transform( x = model, dataset = current) predictions %&gt;% group_by(delayed, prediction) %&gt;% tally() ml_save(model, &quot;saved_model&quot;, overwrite = TRUE) spark_disconnect(sc) library(sparklyr) sc &lt;- spark_connect(master = &quot;local&quot;, version = &quot;2.1.0&quot;) reload &lt;- ml_load(sc, &quot;saved_model&quot;) reload spark_flights &lt;- spark_read_csv(sc, name = &quot;flights&quot;, path = &quot;/usr/share/flights/flights_2008.csv&quot;, memory = FALSE, columns = file_columns, infer_schema = FALSE) current &lt;- tbl(sc, &quot;flights&quot;) %&gt;% filter( month == &quot;2&quot;, dayofmonth == &quot;1&quot; ) %&gt;% sdf_register(., &quot;current&quot;) new_predictions &lt;- ml_transform( x = reload, dataset = current ) new_predictions %&gt;% group_by(delayed, prediction) %&gt;% tally() spark_disconnect(sc) "],
["database-operations.html", "7 Database operations 7.1 Case 1 - Data enrichment", " 7 Database operations 7.1 Case 1 - Data enrichment Upload a small dataset in order to combine it with the datawarehouse data Load the planes data into memory planes &lt;- nycflights13::planes Using DBI, copy the planes data to the datawarehouse as a temporary table dbWriteTable(con, &quot;planes&quot;, planes, temporary = TRUE) Using dplyr, create a variable pointer to the new table tbl_planes &lt;- tbl(con, &quot;planes&quot;) tbl_planes Create a “lazy” variable that joins the flights table to the new temp table combined &lt;- flights %&gt;% left_join(tbl_planes, by = &quot;tailnum&quot;) View a sample of flights of planes with more than 100 seats combined %&gt;% filter(seats &gt; 100) %&gt;% head() See how many flights each plane McDonnel Douglas had combined %&gt;% filter(manufacturer == &quot;MCDONNELL DOUGLAS&quot;) %&gt;% group_by(tailnum) %&gt;% tally() Get the total number of planes, and the average, minimum &amp; maximum number of flights for the manufacturer combined %&gt;% filter(manufacturer == &quot;MCDONNELL DOUGLAS&quot;) %&gt;% group_by(tailnum) %&gt;% tally() %&gt;% summarise(planes = n(), avg_flights = mean(n), max_flights = max(n), min_flights = min(n)) Remove the temp table dbRemoveTable(con, &quot;planes&quot;) dbDisconnect(con) "],
["data-visualizations.html", "8 Data Visualizations 8.1 Simple plot 8.2 Plot in one code segment 8.3 Plot specific data segments 8.4 Two or more queries 8.5 Visualize using dbplot 8.6 Plot a different aggregation 8.7 Create a histogram 8.8 Raster plot 8.9 Using the calculate functions 8.10 Under the hood (II)", " 8 Data Visualizations 8.1 Simple plot Practice pushing the calculations to the database Use collect() bring back the aggregated results into a “pass-through” variable called by_month by_month &lt;- flights %&gt;% group_by(month) %&gt;% tally() %&gt;% mutate(n = as.numeric(n)) %&gt;% collect() head(by_month) Plot results using ggplot2 library(ggplot2) ggplot(by_month) + geom_line(aes(x = month, y = n)) 8.2 Plot in one code segment Practice going from dplyr to ggplot2 without using pass-through variable, great for EDA Using the code from the previous section, create a single piped code set which also creates the plot flights %&gt;% group_by(month) %&gt;% tally() %&gt;% mutate(n = as.numeric(n)) %&gt;% collect() %&gt;% ggplot() + # &lt; Don&#39;t forget to switch to `+` geom_line(aes(x = month, y = n)) Change the aggregation to the average of arrdelay. Tip: Use x as the summarize variable flights %&gt;% group_by(month) %&gt;% summarise(x = mean(arrdelay)) %&gt;% mutate(x = as.numeric(x)) %&gt;% collect() %&gt;% ggplot() + geom_line(aes(x = month, y = x)) Plot the average distance flights %&gt;% group_by(month) %&gt;% summarise(x = mean(distance)) %&gt;% mutate(x = as.numeric(x)) %&gt;% collect() %&gt;% ggplot() + geom_line(aes(x = month, y = x)) 8.3 Plot specific data segments Combine skills from previous units to create more sophisticated plots Start with getting the top 5 carriers flights %&gt;% group_by(uniquecarrier) %&gt;% tally() %&gt;% arrange(desc(n)) %&gt;% head(5) Start with getting the top 5 carriers flights %&gt;% group_by(uniquecarrier) %&gt;% tally() %&gt;% mutate(n = as.numeric(n)) %&gt;% arrange(desc(n)) %&gt;% head(5) %&gt;% collect() %&gt;% ggplot() + geom_col(aes(x = uniquecarrier, y = n)) Improve the plot’s look flights %&gt;% group_by(uniquecarrier) %&gt;% tally() %&gt;% mutate(n = as.numeric(n)) %&gt;% arrange(desc(n)) %&gt;% head(5) %&gt;% collect() %&gt;% ggplot() + #Don&#39;t forget to switch to `+` geom_col(aes(x = uniquecarrier, y = n, fill = n)) + #Add fill theme(legend.position=&quot;none&quot;) + # Turn legend off coord_flip() + # Rotate cols into rows labs(title = &quot;Top 5 Carriers&quot;, subtitle = &quot;Source: Datawarehouse&quot;, x = &quot;Carrier Name&quot;, y = &quot;# of Flights&quot;) 8.4 Two or more queries Learn how to use pull() to pass a set of values to be used on a secondary query Use pull() to get the top 5 carriers loaded in a vector top5 &lt;- flights %&gt;% group_by(uniquecarrier) %&gt;% tally() %&gt;% arrange(desc(n)) %&gt;% head(5) %&gt;% pull(uniquecarrier) top5 Use %in% to pass the top5 vector to a filter flights %&gt;% filter(uniquecarrier %in% top5) Group by carrier and get the average arrival delay flights %&gt;% filter(uniquecarrier %in% top5) %&gt;% group_by(uniquecarrier) %&gt;% summarise(n = mean(arrdelay)) Copy the final ggplot() code from the Plot specific segment section. Update the y labs. flights %&gt;% filter(uniquecarrier %in% top5) %&gt;% group_by(uniquecarrier) %&gt;% summarise(n = mean(arrdelay)) %&gt;% # From previous section ---------------------------------------------- collect() %&gt;% ggplot() + #Don&#39;t forget to switch to `+` geom_col(aes(x = uniquecarrier, y = n, fill = n)) + #Add fill theme(legend.position=&quot;none&quot;) + # Turn legend off coord_flip() + # Rotate cols into rows labs(title = &quot;Top 5 Carriers&quot;, subtitle = &quot;Source: Datawarehouse&quot;, x = &quot;Carrier Name&quot;, y = &quot;Average Delay&quot;) 8.5 Visualize using dbplot Review how to use dbplot to make it easier to plot with databases Install and load dbplot install.packages(&quot;dbplot&quot;) library(dbplot) Create a line plot using the helper function dbplot_line() flights %&gt;% dbplot_line(month) Update the plot’s labels flights %&gt;% dbplot_line(month) + labs(title = &quot;Monthly flights&quot;, x = &quot;Month&quot;, y = &quot;Number of flights&quot;) 8.6 Plot a different aggregation dbplot allows for aggregate functions, other than record count, to be used for plotting Plot the average departure delay by day of week flights %&gt;% dbplot_bar(dayofweek, mean(depdelay)) Change the day numbers to day name labels flights %&gt;% dbplot_bar(dayofweek, mean(depdelay)) + scale_x_continuous(labels = c(&quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;,&quot;Sun&quot;), breaks = 1:7) 8.7 Create a histogram Use the package’s function to easily create a histogram Use the dbplot_histogram() to build the histogram flights %&gt;% dbplot_histogram(distance) Adjust the binwidth to 300 flights %&gt;% dbplot_histogram(distance, binwidth = 300) 8.8 Raster plot Use a dbplot_raster() to visualize deptime versus depdelay flights %&gt;% dbplot_raster(deptime, arrtime) Change the plot’s resolution to 500 flights %&gt;% dbplot_raster(deptime, arrtime, resolution = 500) 8.9 Using the calculate functions Use the db_comptue_raster() function to get the underlying results that feed the plot departure &lt;- flights %&gt;% db_compute_raster(deptime, arrtime) departure Plot the results “manually” departure %&gt;% filter(`n()` &gt; 1000) %&gt;% ggplot() + geom_raster(aes(x = deptime, y = arrtime, fill = `n()`)) 8.10 Under the hood (II) Review how dbplot pushes histogram and raster calculations to the database Use the db_bin() command to see the resulting tidy eval formula db_bin(field) Use trasnlate_sql() and simulate_odbc_postgresql() to see an example of what the resulting SQL statement looks like translate_sql(!! db_bin(field), con = simulate_odbc_postgresql()) "]
]
