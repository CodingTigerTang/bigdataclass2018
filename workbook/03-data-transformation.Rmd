# Data transformation

```{r, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)

library(dplyr)
library(dbplyr)

# Class catchup
con <- DBI::dbConnect(odbc::odbc(), "Postgres Dev")
airports <- tbl(con, in_schema("datawarehouse", "airport"))
flights <- tbl(con, in_schema("datawarehouse", "flight"))
carriers <- tbl(con, in_schema("datawarehouse", "carrier"))

```

## Group and sort records

*Learn how to use `group_by()` and `arrange()` to better understand aggregated data*


1. How many flights are there per month?
```{r}
flights %>%
  group_by(month) %>%
  tally() 
```

2. Order the results by the month number
```{r}
flights %>%
  group_by(month) %>%
  tally() %>%
  arrange(month)
```

3. Order the results by the number of flights, starting with the month with most flights by using `desc()` inside the `arrange()` command
```{r}
flights %>%
  group_by(month) %>%
  tally() %>%
  arrange(desc(n)) 
```

## Answering questions with `dplyr`
*Quick review of how to translate questions into `dplyr` code*

1. Which are the top 4 months with the most flight activity?
```{r}
flights %>%
  group_by(month) %>%
  tally() %>%
  arrange(desc(n)) %>%
  head(4)
```

2. What were the top 5 calendar days with most flight activity?
```{r}
flights %>%
  group_by(month, dayofmonth) %>%
  tally() %>%
  arrange(desc(n)) %>%
  head(5)
```

3. Which are the top 5 carriers (airlines) with the most flights?

```{r}
flights %>%
  group_by(uniquecarrier) %>%
  tally() %>%
  arrange(desc(n)) %>%
  head(5)
```

4. Figure the percent ratio of flights per month
```{r}
flights %>%
  group_by(month) %>%
  tally() %>%
  arrange(desc(n)) %>%
  mutate(percent = n/sum(n))
```


## View record level data
*Important tips to record preview data*


How many flights in July 18th were one or more hours late?
```{r}
flights %>%
  filter(depdelay >= 60,
         month == 7,
         dayofmonth == 18) %>%
  tally() 
```


1. Use `filter()` to retreive only the needed data, and `head()` to limit the preview even further.
```{r}
flights %>%
  filter(depdelay >= 60,
         month == 7,
         dayofmonth == 18) %>%
  head(100)
```

2. Use `collect()` and `View()` to preview the data in the IDE. Make sure to **always** limit the number of returned rows.
```{r, eval = FALSE}
flights %>%
  filter(depdelay >= 60,
         month == 7,
         dayofmonth == 18) %>%
  collect() %>%
  head(100) %>%
  View("my_preview")
```



















